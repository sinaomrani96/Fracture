
[Mesh]
  type = FileMesh
  file = 'coarse.e'
  block_id = '1 2 3'
  block_name = 'fracture matrix1 matrix2'

  boundary_id = '1 2'
  boundary_name = 'bottom top'
[]

[GlobalParams]
  PorousFlowDictator = dictator
  gravity = '0 0 0'
[]

[Variables]
  [pp]
    initial_condition = 1e6
    scaling = 1e7
  []
  [sat]
    initial_condition = 0
    scaling = 1e-8
  []
[]

[AuxVariables]

  [massfrac1]
    family = MONOMIAL
    order = CONSTANT
    initial_condition = 1
  []
  [massfrac2]
    family = MONOMIAL
    order = CONSTANT
    initial_condition = 0
  []
[]



[BCs]
  [co2_injection1]
    type = DirichletBC
    boundary = bottom
    variable = sat    
    value = 1 
  []
  [rp]
    type = DirichletBC
    value = 1e6
    variable = pp
    boundary = top
  []
  [lp]
    type = DirichletBC
    value = 1e6
    variable = pp
    boundary = bottom
  []
  [topco2]
    type = DirichletBC
    boundary = top
    variable = sat   
    value = 0 
  []
 # [right_water]
 #   type = PorousFlowPiecewiseLinearSink
 #   boundary = right
 #   variable = pp
 #   fluid_phase = 0
 #   pt_vals = '0 1E9'
 #   multipliers = '0 1E9'
 #   PT_shift = 1E6
 #   mass_fraction_component = 0
 #   use_mobility = true
 #   use_relperm = false
 #   flux_function = 10 # 1/L
 # []

[]

[Kernels]
  [mass0]
    type = PorousFlowMassTimeDerivative
    fluid_component = 0
    variable = pp
  []
  [adv0]
    type = PorousFlowFluxLimitedTVDAdvection
    advective_flux_calculator = advective_flux_calculator_0
   # type = PorousFlowAdvectiveFlux
   # fluid_component = 0
    variable = pp
  []
  [mass1]
    type = PorousFlowMassTimeDerivative
    fluid_component = 1
    variable = sat
  []
  [adv1]
    type = PorousFlowFluxLimitedTVDAdvection
    advective_flux_calculator = advective_flux_calculator_1
  #  type = PorousFlowAdvectiveFlux
  #  fluid_component = 1
    variable = sat
  []
[]

[UserObjects]
  [dictator]
    type = PorousFlowDictator
    porous_flow_vars = 'pp sat'
    number_fluid_phases = 2
    number_fluid_components = 2
  []
  [pc]
    type = PorousFlowCapillaryPressureBC
    pe = 1e4
    lambda = 2
    #type = PorousFlowCapillaryPressureConst
   
  []
  [advective_flux_calculator_0]
    type = PorousFlowAdvectiveFluxCalculatorUnsaturatedMultiComponent
    flux_limiter_type = VanLeer
    fluid_component = 0
    phase = 0
  []
  [advective_flux_calculator_1]
    type = PorousFlowAdvectiveFluxCalculatorUnsaturatedMultiComponent
    flux_limiter_type = VanLeer
    fluid_component = 1
    phase = 1
  []
[]

[FluidProperties]
  [true_water]
    type = Water97FluidProperties
  []
  [tabulated_water]
    type = TabulatedFluidProperties
    fp = true_water
    temperature_min = 275
    pressure_max = 1E8
    interpolated_properties = 'density viscosity enthalpy internal_energy'
    fluid_property_file = water97_tabulated_11.csv
  []
  [true_co2]
    type = CO2FluidProperties
  []
  [tabulated_co2]
    type = TabulatedFluidProperties
    fp = true_co2
    temperature_min = 275
    pressure_max = 1E8
    interpolated_properties = 'density viscosity enthalpy internal_energy'
    fluid_property_file = co2_tabulated_11.csv
  []
  [simple_fluid1]
    type = SimpleFluidProperties
    bulk_modulus = 2e9
    density0 = 1000
    thermal_expansion = 0
    viscosity = 1e-3
  []
 # [simple_fluid2]
  #  type = SimpleFluidProperties
   # bulk_modulus = 2e9
   # density0 = 700
  #  thermal_expansion = 0
 #   viscosity = 1e-5
#  []
[]

[Materials]
  [permeability_fracture]
    type = PorousFlowPermeabilityConst
    permeability = '1.8e-11 0 0 0 1.8e-11 0 0 0 1.8e-11'   # 1.8e-11 = a * kf
    block = 'fracture'
  []
  [permeability_matrix]
    type = PorousFlowPermeabilityConst
    permeability = '1e-20 0 0 0 1e-20 0 0 0 1e-20'
    block = 'matrix1 matrix2'
  []
  [poro_fracture]
    type = PorousFlowPorosityConst
    porosity = 6e-4   # = a * phif
    block = 'fracture'
  []
  [poro_matrix]
    type = PorousFlowPorosityConst
    porosity = 0.1
    block = 'matrix1 matrix2'
  []
  [temperature]
    type = PorousFlowTemperature
    temperature = 323.15
  []
  [saturation_calculator]
    type = PorousFlow2PhasePS
    phase0_porepressure = pp
    phase1_saturation = sat
    capillary_pressure = pc
  []
  [massfrac1]
    type = PorousFlowMassFraction
    mass_fraction_vars = 'massfrac1 massfrac2'
  []
  [simple_fluid_qpw]
    type = PorousFlowSingleComponentFluid
    fp = simple_fluid1
    phase = 0
  []
  [simple_fluid_qp]
    type = PorousFlowSingleComponentFluid
    fp = simple_fluid1
    phase = 1
  []
  [relperm_water]
    type = PorousFlowRelativePermeabilityCorey
    n = 1
    phase = 0
    s_res = 0.1
    sum_s_res = 0.1
  []

  [relperm_gas]
    type = PorousFlowRelativePermeabilityCorey
    n = 1
    s_res = 0
    sum_s_res = 0.1
    phase = 1
  []

[]


[Debug]
  show_var_residual_norms = true
[]

[Executioner]
  type = Transient
  solve_type = NEWTON
  petsc_options_iname = '-pc_type -ksp_type  -ksp_gmres_restart'
  petsc_options_value = 'none gmres 1000' 
  end_time = 5e3
  dtmax = 10
  [TimeStepper]
    type = IterationAdaptiveDT
    dt = 1
  []
  l_max_its = 100
  l_abs_tol = 1e-20
  nl_max_its = 40
  nl_rel_tol = 1e-14
  nl_abs_tol = 1e-15
[]

[Outputs]
  [out]
    type = Exodus
    execute_on = 'initial timestep_end'
  []
[]
